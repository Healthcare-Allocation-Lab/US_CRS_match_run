---
title: "US-CRS Match Run Analysis"
subtitle: "Comprehensive comparison of current 6-Status, National US-CRS, and Acuity Circle US-CRS allocation systems"
output: html_notebook
---

This notebook performs a comprehensive analysis comparing three heart allocation systems:

1. **Current 6-Status System**: Existing therapy-based allocation with geographic circles
2. **National US-CRS System**: Simplified 24-class continuous risk-based allocation (no distance)
3. **Acuity Circle US-CRS System**: Full 172-class continuous risk-based allocation with geographic circles

## Key Analyses:
- **Sequence Comparisons**: How candidate prioritization changes across systems
- **Status-Specific Impact**: Which current status groups benefit/decline under US-CRS
- **Geographic Analysis**: Impact of removing vs maintaining distance constraints
- **Risk Stratification**: How well each system prioritizes by transplant need (US-CRS scores)

```{r setup}
# Load essential libraries
library(tidyverse)
library(haven)      
library(lubridate)  
library(here)       
library(patchwork)  # For combining plots
library(scales)     # For better axis formatting

# Set plot theme
theme_set(theme_minimal())
```

# Load All Datasets

```{r load-data}
# Load original processed data
load(here("data", "heart_only_match_run_with_uscrs.Rdata"))
print(paste("Loaded original data:", nrow(heart_only_match_run_with_uscrs), "records"))

# Load National US-CRS results (if available)
national_file <- here("data", "heart_only_match_run_national.Rdata")
if(file.exists(national_file)) {
  load(national_file)
  print(paste("Loaded National US-CRS data:", nrow(heart_only_match_run_national), "records"))
} else {
  print("National US-CRS data not found. Please run national_uscrs_allocation.Rmd first.")
}

# Load Acuity Circle US-CRS results (if available)  
acuity_file <- here("data", "heart_only_match_run_counterfactual.Rdata")
if(file.exists(acuity_file)) {
  load(acuity_file)
  print(paste("Loaded Acuity Circle US-CRS data:", nrow(heart_only_match_run_counterfactual), "records"))
} else {
  print("Acuity Circle US-CRS data not found. Please run acuity_circle_uscrs.Rmd first.")
}

print("Ready for comprehensive match run analysis")
```

# Data Summary and Quality Checks
```{r data-summary}
# Check data availability and alignment
data_summary <- tibble(
  System = c("Original (6-Status)", "National US-CRS", "Acuity Circle US-CRS"),
  Records = c(
    nrow(heart_only_match_run_with_uscrs),
    ifelse(exists("heart_only_match_run_national"), nrow(heart_only_match_run_national), 0),
    ifelse(exists("heart_only_match_run_counterfactual"), nrow(heart_only_match_run_counterfactual), 0)
  ),
  Available = c(TRUE, exists("heart_only_match_run_national"), exists("heart_only_match_run_counterfactual"))
)

data_summary
```


```{r}
status_color_palette <- c("Status 1" = "#D23105FF",
                                  "Status 1A (pediatric)" = "#7A0403FF",
                                  "Status 1B (pediatric)" = "#EDD03AFF",
                                  "Status 2" = "#FB8022FF",
                                  "Status 2 (pediatric)" = "#466BE3FF",
                                  "Status 3" = "#A2FC3CFF",
                                  "Status 4" = "#31F299FF",
                                  "Status 5" = "#28BBECFF",
                                  "Status 6" = "#30123BFF")
```


## distribution of US-CRS scores by status
```{r}
if(exists("heart_only_match_run_with_uscrs")) {
  
  # Create a distribution plot of US-CRS scores by status
  us_crs_distribution <- heart_only_match_run_with_uscrs %>%
    filter(!is.na(us_crs_score)) %>%
    filter(status != "Status 1A (pediatric)" & status != "Status 1B (pediatric)") %>%
    ggplot(aes(x = us_crs_score, fill = status)) +
    geom_histogram(alpha = 0.6, breaks = seq(-0.5, 50.5,2)) +
    scale_color_manual(values = status_color_palette) +
    labs(
      title = "Distribution of US-CRS Scores by Current Heart Status",
      x = "US-CRS Score",
      y = "Number of candidates"
    ) +
    theme_minimal() +
    theme(
      plot.title = element_text(size = 14, face = "bold"),
      legend.position = "right"
    ) + facet_wrap(~status, scales = "free_y") 
  
  print(us_crs_distribution)
  
  # Save the distribution plot
  ggsave(here("results", "us_crs_score_distribution_by_status.png"), us_crs_distribution, 
         width = 10, height = 6, dpi = 300)
  
} else {
  cat("US-CRS score distribution plot requires heart_only_match_run_with_uscrs dataset\\n")
}
```

# System-to-System Sequence Comparison
```{r sequence-comparison}


# Only proceed if all datasets are available
if(exists("heart_only_match_run_national") && exists("heart_only_match_run_counterfactual")) {
  
  # Create comprehensive comparison dataset
  sequence_comparison <- heart_only_match_run_with_uscrs %>%
    # Add National US-CRS sequence
    left_join(
      heart_only_match_run_national %>% 
        select(PX_ID, MATCH_ID, national_uscrs_sequence, national_uscrs_classification),
      by = c("PX_ID", "MATCH_ID")
    ) %>%
    # Add Acuity Circle US-CRS sequence  
    left_join(
      heart_only_match_run_counterfactual %>% 
        select(PX_ID, MATCH_ID, us_crs_sequence, acuity_uscrs_classification = us_crs_classification),
      by = c("PX_ID", "MATCH_ID")
    ) %>%
    rename(
      current_sequence = PTR_SEQUENCE_NUM,
      national_sequence = national_uscrs_sequence,
      acuity_sequence = us_crs_sequence
    ) %>%
    # Calculate sequence changes
    mutate(
      national_vs_current = national_sequence - current_sequence,
      acuity_vs_current = acuity_sequence - current_sequence,
      national_vs_acuity = national_sequence - acuity_sequence
    )
  
  print(paste("Created comparison dataset with", nrow(sequence_comparison), "records"))
  
  # Sequence change summary
  sequence_summary <- sequence_comparison %>%
    summarise(
      # Changes vs Current System
      national_improved = sum(national_vs_current < 0, na.rm = TRUE),
      national_declined = sum(national_vs_current > 0, na.rm = TRUE),
      national_unchanged = sum(national_vs_current == 0, na.rm = TRUE),
      
      acuity_improved = sum(acuity_vs_current < 0, na.rm = TRUE),
      acuity_declined = sum(acuity_vs_current > 0, na.rm = TRUE),
      acuity_unchanged = sum(acuity_vs_current == 0, na.rm = TRUE),
      
      # National vs Acuity comparison
      national_better = sum(national_vs_acuity < 0, na.rm = TRUE),
      acuity_better = sum(national_vs_acuity > 0, na.rm = TRUE),
      systems_equal = sum(national_vs_acuity == 0, na.rm = TRUE),
      
      total_records = n()
    )
  
  print("Sequence Change Summary:")
  print(sequence_summary)
  
} else {
  print("Skipping sequence comparison - missing datasets")
}
```

# INDIVIDUAL MATCH RUN ANALYSIS

## General match run visualization function
```{r}
# Visualize match run for a specific match ID colored by US-CRS score
visualize_match_run <- function(match_id, 
                                policy = "acuity-us-crs",
                                match_data = sequence_comparison,
                                    show_us_crs = TRUE,
                                    sequence_limit = 300) {
  
  # Get match run information
  match_info <- match_data %>%
    filter(MATCH_ID == match_id) %>%
    select(DONOR_ID, DON_ABO, MATCH_SUBMIT_DT) %>%
    distinct()
  
  if(nrow(match_info) == 0) {
    stop("Match ID not found in dataset")
  }
  
  donor_id <- match_info$DONOR_ID
  donor_blood_type <- match_info$DON_ABO
  match_date <- match_info$MATCH_SUBMIT_DT
  

  # Get recipient distance for the rectangle
  recipient_distance <- match_data %>%
    filter(is.na(REC_TX_DT) == FALSE & MATCH_ID == match_id) %>%
    pull(PTR_DISTANCE)
  

  
  
  if (policy == "current"){
    match_data <- match_data %>%
      mutate(sequence = current_sequence)
  } else if (policy == "national-us-crs"){
    match_data <- match_data %>%
      mutate(sequence = national_sequence)
  } else if (policy == "acuity-us-crs"){
    match_data <- match_data %>%
      mutate(sequence = acuity_sequence)
  } else {
    stop("Invalid policy specified. Use 'current', 
         'national-us-crs', or 'acuity-us-crs'.")
  }
  
    # Get the actual recipient sequence number as numeric value
  tx_seq_number <- match_data %>%
    filter(is.na(REC_TX_DT) == FALSE & MATCH_ID == match_id) %>%
    pull(sequence)
  
  original_tx_seq_number <- match_data %>%
    filter(is.na(REC_TX_DT) == FALSE & MATCH_ID == match_id) %>%
    pull(current_sequence)
  
    if(length(tx_seq_number) == 0 || is.na(tx_seq_number)) {
     outcome <- "Not utilized"
  } else {
     outcome <- paste("Recipient at sequence:", tx_seq_number, "\nDistance:", recipient_distance, "NM")
  }
  
  # Greyscale for US-CRS, ordered colors for status urgency
    if (show_us_crs){
      p <- match_data %>% filter(MATCH_ID == match_id) %>%
        ggplot(aes(x = sequence, y = PTR_DISTANCE, 
               fill = us_crs_score, color = status)) +
            scale_fill_gradient(low = "white", 
                                high = "black", na.value = "grey90", 
                        name = "US-CRS Score")
    } else{
      p <- match_data %>% filter(MATCH_ID == match_id) %>%
        ggplot(aes(x = sequence, y = PTR_DISTANCE, 
               color = status))
    }
  
  p <- p + geom_point(shape = 21, size = 2, alpha = 0.8, stroke = 1) + 
    scale_color_manual(values = status_color_palette,
                       name = "Current Status") + 
    labs(x = "Sequence Number", y = "Distance (NM)", 
         fill = "US-CRS Score", color = "Heart Status", linetype = "Recipient", shape = "Candidate blood type") +
    ggtitle(paste0("Match ID: ", match_id, " | Donor: ", donor_id, " (", donor_blood_type, ") | ", outcome)) +
    theme_minimal()
    

  # Add vertical line and rectangle only if there was a transplant
  if(length(tx_seq_number) > 0 && !is.na(tx_seq_number)) {
    p <- p + 
      geom_rect(
        xmin = tx_seq_number - 2,
        xmax = tx_seq_number + 2,
        ymin = recipient_distance - 25,
        ymax = recipient_distance + 25,
        fill = NA,
        color = "red",
        linewidth = 1
      ) + 
      scale_linetype_manual(values = "dashed")
  }
  
  return(p)
}
```

```{r }
# Visualize a specific match run with US-CRS scores
sample_match_id <- heart_only_match_run_counterfactual$MATCH_ID[5]  

visualize_match_run(sample_match_id, policy = "current", show_us_crs = FALSE)

ggsave(here("results", "status_quo_example.pdf"))
```

```{r }
visualize_match_run(sample_match_id, policy = "current", show_us_crs = TRUE)

ggsave(here("results", "status_quo_example_with_uscrs.pdf"))
```

```{r }
visualize_match_run(sample_match_id, policy = "current", show_us_crs = TRUE) + lims(x = c(0, 100))

ggsave(here("results", "status_quo_example_with_uscrs_zoomed_in.pdf"))
```

## National US-CRS allocation for a single match run
```{r}
visualize_match_run(sample_match_id, policy = "national-us-crs", 
                    show_us_crs = TRUE)

ggsave(here("results", "national_uscrs_example.pdf"))
```
```{r}
visualize_match_run(sample_match_id, policy = "national-us-crs", 
                    show_us_crs = TRUE) + lims(x = c(0, 100))

ggsave(here("results", "national_uscrs_example_first_100.pdf"))
```
## Acuity circle US-CRS allocation for a single match run
```{r}
visualize_match_run(sample_match_id, policy = "acuity-us-crs", 
                    show_us_crs = TRUE)

ggsave(here("results", "acuity_uscrs_example.pdf"))
```
```{r}
visualize_match_run(sample_match_id, policy = "acuity-us-crs", 
                    show_us_crs = TRUE) + lims(x = c(0, 100))

ggsave(here("results", "acuity_uscrs_example_first_100.pdf"))
```

## Sequence shift plot

```{r}
plot_seqence_shifts <- function(match_id, policy = "acuity-us-crs"){
  
  recipient_PX_ID <- sequence_comparison %>%
    filter(is.na(REC_TX_DT) == FALSE & MATCH_ID == match_id) %>%
    pull(PX_ID) %>% unique()
  
  match_data <- sequence_comparison %>%
    filter(MATCH_ID == match_id)
  if (policy == "national-us-crs"){
    match_data <- match_data %>%
      select(PX_ID, national_sequence, current_sequence, us_crs_score) %>%
      mutate(sequence_change = national_sequence - current_sequence) %>%
      pivot_longer(
      cols = c(current_sequence, national_sequence),
      names_to = "allocation_system",
      values_to = "sequence_position"
    ) %>%
      mutate(allocation_system = factor(allocation_system, levels = c("current_sequence", "national_sequence"),
                                        labels = c("Current 6-Status", "National US-CRS")))
  } else if (policy == "acuity-us-crs"){
      match_data <- match_data %>%
        select(PX_ID, acuity_sequence, current_sequence, us_crs_score) %>%
        mutate(sequence_change = acuity_sequence - current_sequence) %>%
        pivot_longer(
          cols = c(current_sequence, acuity_sequence),
          names_to = "allocation_system",
          values_to = "sequence_position"
        )  %>%
        mutate(allocation_system = factor(allocation_system, levels = c("current_sequence", "acuity_sequence"),
                                        labels = c("Current 6-Status", "Acuity Circle US-CRS")))
  } else {
    stop("Invalid policy specified. Use 
         'national-us-crs', or 'acuity-us-crs'.")
  }
  
  match_data %>%
    ggplot(aes(y = allocation_system, x = sequence_position, 
               color = us_crs_score, group = PX_ID)) +
    geom_line(alpha = 0.5) + 
    scale_color_gradient(low = "white", 
                                high = "black", na.value = "grey90", 
                        name = "US-CRS Score") +
    labs(
      title = paste("Sequence Position Changes for Match ID:", match_id),
      subtitle = paste("Comparison of Current vs Acuity Circle US-CRS Sequence Positions"), 
      y = "Allocation System",
      x = "Sequence Position (Lower = Higher Priority)",
      color = "Sequence Change"
    ) +
    theme_minimal()
    
}

plot_seqence_shifts(sample_match_id)
```

## check high US-CRS score patients that dropped
```{r}
sequence_comparison %>%
  filter(MATCH_ID == sample_match_id) %>%
  mutate(acuity_change = acuity_sequence - current_sequence) %>%
  filter(is.na(us_crs_score) == FALSE) %>%
  ggplot(aes(x = us_crs_score, y = acuity_change)) +
  geom_point(alpha = 0.5)
```


## Investigate high US-CRS score patients that dropped in sequence
```{r}
sequence_comparison %>%
  filter(MATCH_ID == sample_match_id) %>%
  mutate(acuity_change = acuity_sequence - current_sequence) %>%
  filter(us_crs_score == 50 & acuity_change > 0) %>%
  select(status, CAN_ABO, DON_ABO, PTR_DISTANCE, PTR_CLASS_ALLOC_CAT, current_sequence, acuity_sequence, acuity_uscrs_classification)
```


# NATIONAL ALLOCATION 


## Visualization: Sequence Position Comparison
```{r sequence-viz}
if(exists("sequence_comparison")) {
  
  # Prepare data for visualization
  viz_data <- sequence_comparison %>%
    filter(!is.na(current_sequence) & !is.na(national_sequence) & !is.na(acuity_sequence)) %>%
    pivot_longer(
      cols = c(current_sequence, national_sequence, acuity_sequence),
      names_to = "allocation_system",
      values_to = "sequence_position"
    ) %>%
    mutate(
      allocation_system = case_when(
        allocation_system == "current_sequence" ~ "Current 6-Status",
        allocation_system == "national_sequence" ~ "National US-CRS", 
        allocation_system == "acuity_sequence" ~ "Acuity Circle US-CRS"
      ),
      allocation_system = factor(allocation_system, 
                                levels = c("Current 6-Status", "National US-CRS", "Acuity Circle US-CRS"))
    ) %>%
    filter(sequence_position <= 100) %>%  # Focus on top 100 for clarity
    group_by(allocation_system, sequence_position) %>%
    summarise(
      median_uscrs = median(us_crs_score, na.rm = TRUE),
      mean_uscrs = mean(us_crs_score, na.rm = TRUE),
      n_candidates = n(),
      .groups = "drop"
    )
  
  # Main sequence comparison plot
  p1 <- viz_data %>%
    ggplot(aes(x = sequence_position, y = median_uscrs, color = allocation_system)) +
    geom_line(size = 1.2, alpha = 0.8) +
    geom_point(alpha = 0.6, size = 0.8) +
    scale_x_continuous(breaks = seq(0, 100, 20)) +
    labs(
      title = "US-CRS Risk Stratification by Allocation System",
      subtitle = "Higher median US-CRS scores indicate better risk prioritization",
      x = "Sequence Position (Lower = Higher Priority)",
      y = "Median US-CRS Score"
    ) +
    theme_minimal() +
    theme(
      plot.title = element_text(size = 14, face = "bold"),
      legend.position = "bottom"
    )
  
  print(p1)
  
  # Save the main plot
  ggsave(here("results", "three_system_sequence_comparison.png"), p1, 
         width = 12, height = 8, dpi = 300)
  
} else {
  print("Skipping sequence visualization - comparison data not available")
}


ggsave(here("results", "us_crs_score_by_position.pdf"))
```

# Current status distribution for all allocation policies
```{r status-distribution-all-systems}
if(exists("sequence_comparison")) {
  
  # Create comprehensive status distribution visualization
  status_distribution_data <- sequence_comparison %>%
    filter(!is.na(current_sequence) & !is.na(national_sequence) & !is.na(acuity_sequence)) %>%
    pivot_longer(
      cols = c(current_sequence, national_sequence, acuity_sequence),
      names_to = "allocation_system",
      values_to = "sequence_position"
    ) %>%
    mutate(
      allocation_system = case_when(
        allocation_system == "current_sequence" ~ "Current 6-Status",
        allocation_system == "national_sequence" ~ "National US-CRS", 
        allocation_system == "acuity_sequence" ~ "Acuity Circle US-CRS"
      ),
      allocation_system = factor(allocation_system, 
                                levels = c("Current 6-Status", "National US-CRS", "Acuity Circle US-CRS"))
    ) %>%
    filter(sequence_position <= 100) %>%  # Focus on top 100 candidates for clarity
    group_by(allocation_system, sequence_position, status) %>%
    summarise(
      n_candidates = n(),
      .groups = "drop"
    )
  
  p_status_dist <- status_distribution_data %>%
    ggplot(aes(x = sequence_position, y = n_candidates, fill = status)) +
    geom_area(position = "fill", alpha = 0.8) +
    facet_wrap(~allocation_system, ncol = 1) +
    scale_fill_viridis_d(option = "turbo", direction = -1, 
                      name = "Current Status") +
    scale_y_continuous(labels = scales::percent_format()) +
    labs(
      title = "Candidate Status Distribution Across All Allocation Systems",
      subtitle = "Proportion of candidates by current heart status across sequence positions (Top 100)",
      x = "Sequence Position (Lower = Higher Priority)",
      y = "Proportion of Candidates"
    ) +
    theme_minimal() +
    theme(
      plot.title = element_text(size = 14, face = "bold"),
      plot.subtitle = element_text(size = 11, color = "gray40"),
      strip.text = element_text(face = "bold", size = 11),
      legend.position = "right"
    )
  
  print(p_status_dist)
  
  # Save the comprehensive status distribution plot
  ggsave(here("results", "status_distribution_all_systems.png"), p_status_dist, 
         width = 14, height = 12, dpi = 300)
  
  # Summary statistics for status distribution
  status_dist_summary <- status_distribution_data %>%
    group_by(allocation_system, status) %>%
    summarise(
      total_in_top100 = sum(n_candidates),
      avg_position = round(weighted.mean(sequence_position, n_candidates), 1),
      .groups = "drop"
    ) %>%
    arrange(allocation_system, avg_position)
  
  print("Status Distribution Summary (Top 100 positions):")
  print(status_dist_summary)
  
} else {
  # Fallback to two-system comparison if sequence_comparison doesn't exist
  print("Using fallback two-system comparison...")
  
  heart_only_match_run_national %>%
    select(PX_ID, MATCH_ID, PTR_SEQUENCE_NUM, us_crs_score, national_uscrs_sequence, status) %>%
    rename(current_sequence = PTR_SEQUENCE_NUM) %>%
    pivot_longer(cols = c(current_sequence, national_uscrs_sequence), 
                 names_to = "allocation_system", 
                 values_to = "sequence_position") %>%
    mutate(
      allocation_system = case_when(
        allocation_system == "current_sequence" ~ "Current 6-Status System",
        allocation_system == "national_uscrs_sequence" ~ "National US-CRS System"
      ),
      allocation_system = factor(allocation_system, levels = c("Current 6-Status System", "National US-CRS System"))) %>%
    group_by(allocation_system, sequence_position, status) %>%
    filter(sequence_position <= 100) %>%  # Focus on top 100 candidates for clarity
    summarise(
      n_candidates = n(),
      .groups = "drop"
    ) %>%
    ggplot(aes(x = sequence_position, y = n_candidates, fill = status)) +
    geom_area(position = "fill", alpha = 0.8) +
    facet_wrap(~allocation_system, ncol = 1) +
    scale_fill_manual(values = status_color_palette) +
    scale_y_continuous(labels = scales::percent_format()) +
    labs(
      title = "Candidate Status Distribution by Allocation System",
      subtitle = "Proportion of candidates by status across sequence positions (Top 100)",
      x = "Sequence Position (Lower = Higher Priority)",
      y = "Proportion of Candidates"
    ) + theme_minimal()
}



ggsave(here("results", "status_distribution_fallback.pdf"))
```

## Distance by sequence analysis
```{r}
sequence_comparison %>%
  pivot_longer(
      cols = c(current_sequence, national_sequence, acuity_sequence),
      names_to = "allocation_system",
      values_to = "sequence_position"
    ) %>%
    mutate(
      allocation_system = case_when(
        allocation_system == "current_sequence" ~ "Current 6-Status",
        allocation_system == "national_sequence" ~ "National US-CRS", 
        allocation_system == "acuity_sequence" ~ "Acuity Circle US-CRS"
      ),
      allocation_system = factor(allocation_system, 
                                levels = c("Current 6-Status", "National US-CRS", "Acuity Circle US-CRS"))
    ) %>%
  group_by(allocation_system, sequence_position) %>%
  filter(sequence_position < 100) %>%
  summarise(
    median_distance = median(PTR_DISTANCE, na.rm = TRUE),
    mean_distance = mean(PTR_DISTANCE, na.rm = TRUE),
    low_iqr = quantile(PTR_DISTANCE, 0.25, na.rm = TRUE),
    high_iqr = quantile(PTR_DISTANCE, 0.75, na.rm = TRUE)
  ) %>%
  ggplot(aes(x = sequence_position, y = median_distance, 
             ymin = low_iqr, ymax = high_iqr, color = allocation_system)) +
  geom_line(size = 1.2, alpha = 0.8) +
  geom_point(alpha = 0.6, size = 0.8) +
  #geom_errorbar(width = 0.2, alpha = 0.5) +
  scale_x_continuous(breaks = seq(0, 100, 20)) +
    labs(
      title = "US-CRS Risk Stratification by Allocation System",
      subtitle = "Higher median US-CRS scores indicate better risk prioritization",
      x = "Sequence Position (Lower = Higher Priority)",
      y = "Median US-CRS Score"
    ) +
    theme_minimal() +
    theme(
      plot.title = element_text(size = 14, face = "bold"),
      legend.position = "bottom"
    )
  
```


# WORKING FIGURES
## Priority change by US-CRS score
```{r }
# Analyze the impact of switching to national US-CRS
sequence_impact <- heart_only_match_run_national %>%
  mutate(
    sequence_change = national_uscrs_sequence - PTR_SEQUENCE_NUM,
    improvement_category = case_when(
      sequence_change <= -10 ~ "Major Improvement (≥10 spots up)",
      sequence_change <= -5 ~ "Moderate Improvement (5-9 spots up)", 
      sequence_change <= -1 ~ "Minor Improvement (1-4 spots up)",
      sequence_change == 0 ~ "No Change",
      sequence_change <= 4 ~ "Minor Decline (1-4 spots down)",
      sequence_change <= 9 ~ "Moderate Decline (5-9 spots down)",
      sequence_change >= 10 ~ "Major Decline (≥10 spots down)"
    ),
    improvement_category = factor(improvement_category, levels = c(
      "Major Improvement (≥10 spots up)",
      "Moderate Improvement (5-9 spots up)", 
      "Minor Improvement (1-4 spots up)",
      "No Change",
      "Minor Decline (1-4 spots down)",
      "Moderate Decline (5-9 spots down)",
      "Major Decline (≥10 spots down)"
    ))
  )

# Impact by US-CRS score
p2 <- sequence_impact %>%
  filter(!is.na(us_crs_score) & !is.na(improvement_category)) %>%
  ggplot(aes(x = us_crs_score, fill = improvement_category)) +
  geom_histogram(binwidth = 2, alpha = 0.8, color = "white", size = 0.1) +
  scale_fill_brewer(type = "div", palette = "RdYlGn", name = "Sequence Change", 
                    guide = guide_legend(reverse = TRUE)) +
  labs(
    title = "Impact of National US-CRS Allocation by Risk Score",
    subtitle = "How sequence position changes vary across US-CRS risk levels",
    x = "US-CRS Score (Higher = Higher Transplant Need)",
    y = "Number of Candidates"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(size = 14, face = "bold"),
    plot.subtitle = element_text(size = 11, color = "gray40"),
    legend.position = "bottom",
    legend.title = element_text(size = 10, face = "bold")
  ) +
  guides(fill = guide_legend(nrow = 2, byrow = TRUE))

print(p2)

# Save impact analysis
ggsave(here("results", "national_uscrs_impact_by_score.png"), p2, 
       width = 12, height = 8, dpi = 300)

# Summary statistics
impact_summary <- sequence_impact %>%
  filter(!is.na(improvement_category)) %>%
  count(improvement_category) %>%
  mutate(percentage = round(n / sum(n) * 100, 1))

print("Sequence Change Impact Summary:")
print(impact_summary)
```

## Status-Specific Impact Analysis
```{r status-impact}
if(exists("sequence_comparison")) {
  
  # Analyze impact by current status
  status_impact <- sequence_comparison %>%
    filter(!is.na(status) & !is.na(national_vs_current) & !is.na(acuity_vs_current)) %>%
    group_by(status) %>%
    summarise(
      n_candidates = n(),
      mean_uscrs = round(mean(us_crs_score, na.rm = TRUE), 1),
      
      # National US-CRS impacts
      national_mean_change = round(mean(national_vs_current, na.rm = TRUE), 1),
      national_median_change = round(median(national_vs_current, na.rm = TRUE), 1),
      national_pct_improved = round(sum(national_vs_current < 0, na.rm = TRUE) / n() * 100, 1),
      
      # Acuity Circle US-CRS impacts  
      acuity_mean_change = round(mean(acuity_vs_current, na.rm = TRUE), 1),
      acuity_median_change = round(median(acuity_vs_current, na.rm = TRUE), 1),
      acuity_pct_improved = round(sum(acuity_vs_current < 0, na.rm = TRUE) / n() * 100, 1),
      
      .groups = "drop"
    ) %>%
    arrange(mean_uscrs)
  
  print("Status-Specific Impact Analysis:")
  print(status_impact)
  
  # Visualization of status impacts
  status_viz_data <- sequence_comparison %>%
    filter(!is.na(status)) %>%
    select(status, national_vs_current, acuity_vs_current) %>%
    pivot_longer(
      cols = c(national_vs_current, acuity_vs_current),
      names_to = "comparison_type",
      values_to = "sequence_change"
    ) %>%
    mutate(
      comparison_type = case_when(
        comparison_type == "national_vs_current" ~ "National vs Current",
        comparison_type == "acuity_vs_current" ~ "Acuity Circle vs Current"
      )
    )
  
  p2 <- status_viz_data %>%
    ggplot(aes(x = status, y = sequence_change, fill = comparison_type)) +
    geom_boxplot(alpha = 0.7, outlier.alpha = 0.3) +
    geom_hline(yintercept = 0, linetype = "dashed", color = "red", alpha = 0.7) +
    scale_fill_viridis_d(option = "turbo", name = "System Comparison") +
    labs(
      title = "Sequence Position Changes by Current Heart Status",
      subtitle = "Negative values = improved priority, Positive values = lower priority",
      x = "Current Heart Status",
      y = "Sequence Position Change"
    ) +
    theme_minimal() +
    theme(
      plot.title = element_text(size = 14, face = "bold"),
      axis.text.x = element_text(angle = 45, hjust = 1),
      legend.position = "bottom"
    ) +
    facet_wrap(~comparison_type, scales = "free_y")
  
  print(p2)
  
  ggsave(here("results", "status_specific_impact.png"), p2, 
         width = 14, height = 8, dpi = 300)
  
} else {
  print("Skipping status impact analysis - comparison data not available")
}
```


## Detailed Sequence Analysis for national allocation
```{r sequence-impact-analysis}
# Analyze the impact of switching to national US-CRS
sequence_impact <- heart_only_match_run_national %>%
  mutate(
    sequence_change = national_uscrs_sequence - PTR_SEQUENCE_NUM,
    improvement_category = case_when(
      sequence_change <= -10 ~ "Major Improvement (≥10 spots up)",
      sequence_change <= -5 ~ "Moderate Improvement (5-9 spots up)", 
      sequence_change <= -1 ~ "Minor Improvement (1-4 spots up)",
      sequence_change == 0 ~ "No Change",
      sequence_change <= 4 ~ "Minor Decline (1-4 spots down)",
      sequence_change <= 9 ~ "Moderate Decline (5-9 spots down)",
      sequence_change >= 10 ~ "Major Decline (≥10 spots down)"
    ),
    improvement_category = factor(improvement_category, levels = c(
      "Major Improvement (≥10 spots up)",
      "Moderate Improvement (5-9 spots up)", 
      "Minor Improvement (1-4 spots up)",
      "No Change",
      "Minor Decline (1-4 spots down)",
      "Moderate Decline (5-9 spots down)",
      "Major Decline (≥10 spots down)"
    ))
  )

# Impact by US-CRS score
p2 <- sequence_impact %>%
  filter(!is.na(us_crs_score) & !is.na(improvement_category)) %>%
  ggplot(aes(x = us_crs_score, fill = improvement_category)) +
  geom_histogram(binwidth = 2, alpha = 0.8, color = "white", size = 0.1) +
  scale_fill_brewer(type = "div", palette = "RdYlGn", name = "Sequence Change", 
                    guide = guide_legend(reverse = TRUE)) +
  labs(
    title = "Impact of National US-CRS Allocation by Risk Score",
    subtitle = "How sequence position changes vary across US-CRS risk levels",
    x = "US-CRS Score (Higher = Higher Transplant Need)",
    y = "Number of Candidates"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(size = 14, face = "bold"),
    plot.subtitle = element_text(size = 11, color = "gray40"),
    legend.position = "bottom",
    legend.title = element_text(size = 10, face = "bold")
  ) +
  guides(fill = guide_legend(nrow = 2, byrow = TRUE))

print(p2)

# Save impact analysis
ggsave(here("results", "national_uscrs_impact_by_score.png"), p2, 
       width = 12, height = 8, dpi = 300)

# Summary statistics
impact_summary <- sequence_impact %>%
  filter(!is.na(improvement_category)) %>%
  count(improvement_category) %>%
  mutate(percentage = round(n / sum(n) * 100, 1))

print("Sequence Change Impact Summary:")
print(impact_summary)
```


