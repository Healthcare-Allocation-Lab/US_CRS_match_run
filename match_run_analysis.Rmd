---
title: "Summarize US-CRS match run analysis"
output: html_notebook
---

```{r}
library(tidyverse)
library(here)
```




```{r}
heart_only_match_run_counterfactual %>%
    select(PX_ID, MATCH_ID, PTR_SEQUENCE_NUM, us_crs_score, us_crs_sequence, status) %>%
  rename(current_sequence = PTR_SEQUENCE_NUM) %>%
  pivot_longer(cols = c(current_sequence, us_crs_sequence), 
               names_to = "allocation_system", 
               values_to = "sequence_position") %>%
  mutate(
    allocation_system = case_when(
      allocation_system == "current_sequence" ~ "Current 6-Status System",
      allocation_system == "us_crs_sequence" ~ "US-CRS System"
    ),
    allocation_system = factor(allocation_system, levels = c("Current 6-Status System", "US-CRS System"))) %>%
  group_by(allocation_system, sequence_position, status) %>%
  filter(sequence_position <= 100) %>%  # Focus on top 100 candidates for clarity
  summarise(
    median_us_crs = median(us_crs_score, na.rm = TRUE),
    # add IQR
    upper_iqr_us_crs = quantile(us_crs_score, 0.75, na.rm = TRUE),
    lower_iqr_us_crs = quantile(us_crs_score, 0.25, na.rm = TRUE),
    n_candidates = n(),
    .groups = "drop"
  ) %>%
  ggplot(aes(x = sequence_position, y = n_candidates, fill = status)) +
  geom_area(position = "fill", alpha = 0.8) +
  facet_wrap(~allocation_system, ncol = 1) +
  scale_fill_viridis_d(option = "turbo", name = "Current Status", direction = -1) +
  labs(
    title = "Candidate Status Distribution by Allocation System",
    subtitle = "Proportion of candidates by status across sequence positions",
    x = "Sequence Position (Lower = Higher Priority)",
    y = "Proportion of Candidates"
  ) + theme_minimal()
```


## Status distribuion for both allocation policies
```{r}
heart_only_match_run_national %>%
  select(PX_ID, MATCH_ID, PTR_SEQUENCE_NUM, us_crs_score, national_uscrs_sequence, status) %>%
  rename(current_sequence = PTR_SEQUENCE_NUM) %>%
  pivot_longer(cols = c(current_sequence, national_uscrs_sequence), 
               names_to = "allocation_system", 
               values_to = "sequence_position") %>%
  mutate(
    allocation_system = case_when(
      allocation_system == "current_sequence" ~ "Current 6-Status System",
      allocation_system == "national_uscrs_sequence" ~ "National US-CRS System"
    ),
    allocation_system = factor(allocation_system, levels = c("Current 6-Status System", "National US-CRS System"))) %>%
  group_by(allocation_system, sequence_position, status) %>%
  filter(sequence_position <= 100) %>%  # Focus on top 100 candidates for clarity
  summarise(
    median_us_crs = median(us_crs_score, na.rm = TRUE),
    # add IQR
    upper_iqr_us_crs = quantile(us_crs_score, 0.75, na.rm = TRUE),
    lower_iqr_us_crs = quantile(us_crs_score, 0.25, na.rm = TRUE),
    n_candidates = n(),
    .groups = "drop"
  ) %>%
  ggplot(aes(x = sequence_position, y = n_candidates, fill = status)) +
  geom_area(position = "fill", alpha = 0.8) +
  facet_wrap(~allocation_system, ncol = 1) +
  scale_fill_viridis_d(option = "turbo", name = "Current Status", direction = -1) +
  labs(
    title = "Candidate Status Distribution by Allocation System",
    subtitle = "Proportion of candidates by status across sequence positions",
    x = "Sequence Position (Lower = Higher Priority)",
    y = "Proportion of Candidates"
  ) + theme_minimal()
  
```